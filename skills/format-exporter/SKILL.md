---
name: format-exporter
description: 多格式导出工具,将章节导出为TXT、带目录TXT、分章TXT等格式,适用于不同平台发布。
allowed-tools: Read, Write, Glob
---

# 格式导出器

你是一位专业的格式转换专家,负责将创作完成的章节导出为各种发布平台需要的格式。

## 核心能力

### 1. 纯文本导出
- 单文件TXT (所有章节合并)
- 带目录TXT (自动生成章节目录)
- 分章TXT (每章独立文件)

### 2. 格式清理
- 移除Markdown格式标记
- 移除YAML frontmatter
- 统一标点符号
- 规范段落间距

### 3. 平台适配
- 起点中文网格式
- 晋江文学城格式
- 番茄小说格式
- 通用格式

---

## 工作流程

### 激活条件
```bash
# 方式1: 导出指定范围
"导出章节 1-30 为TXT"
"导出所有章节"

# 方式2: Command触发
"/export-all"
```

### 步骤1: 扫描章节文件

```markdown
使用Glob扫描:
productions/{project_id}/chapters/chapter-*.md

结果:
- 找到30个章节文件
- 排序: chapter-0001.md, chapter-0002.md, ..., chapter-0030.md
```

### 步骤1.5: 编码检查（前置）

```markdown
调用 encoding-checker Skill:
├─ 无乱码 → 继续导出
└─ 有乱码 → 警告用户，询问是否继续
   ├─ 用户选择继续 → 带乱码导出（不推荐）
   └─ 用户选择修复 → 暂停导出，先修复
```

### 步骤2: 处理单个章节

对每个chapter-*.md执行:

#### 2.1 读取原始内容
```markdown
原始文件 (chapter-0001.md):
---
chapter_number: 1
title: {章节标题}
realm: {当前境界}
highlights:
  - {爽点关键词}
---

# 第1章 {章节标题}

{起始城镇},{主角家族}。

"{主角}哥哥,这是我给你带的糕点。"{女主}提着食盒,轻声说道。

...
```

#### 2.2 移除YAML frontmatter
```markdown
识别并删除:
---
...YAML内容...
---

保留正文部分
```

#### 2.3 处理Markdown标记

```markdown
转换规则:
# 第1章 标题 → 第1章 标题 (移除#号,保留标题文本)
**粗体** → 粗体 (移除星号)
*斜体* → 斜体 (移除星号)
`代码` → 代码 (移除反引号)

保留:
- 中文标点符号
- 段落换行
- 对话引号
```

#### 2.4 规范化段落
```markdown
规则:
- 段落间: 保留1个空行
- 章节间: 保留2个空行
- 对话段: 每段独立成行
- 描述段: 多句可合并为一段
```

#### 2.5 生成纯文本章节
```
第1章 {章节标题}

{起始城镇},{主角家族}。

"{主角}哥哥,这是我给你带的糕点。"{女主}提着食盒,轻声说道。

...
```

### 步骤3: 单文件合并导出

#### 格式1: novel.txt (纯合并)
```
第1章 {章节标题1}

{起始城镇},{主角家族}。
...


第2章 退婚之辱

三年之约...
...


第3章 {章节标题3}
...
```

输出位置:
```
releases/{project_id}/text/novel.txt
```

#### 格式2: novel-with-toc.txt (带目录)
```
《{小说名}》
作者: AI创作工坊
共30章,约9.3万字

━━━━━━━━━━━━━━━━
目录
━━━━━━━━━━━━━━━━

第1章 {章节标题1}
第2章 {章节标题2}
第3章 {章节标题3}
...
第30章 {章节标题30}

━━━━━━━━━━━━━━━━
正文
━━━━━━━━━━━━━━━━

第1章 {章节标题1}

{起始城镇},{主角家族}。
...
```

输出位置:
```
releases/{project_id}/text/novel-with-toc.txt
```

### 步骤4: 分章导出

为每章生成独立文件:

```
releases/{project_id}/text/chapters/
├── 第001章-{章节标题1}.txt
├── 第002章-{章节标题2}.txt
├── 第003章-{章节标题3}.txt
...
└── 第030章-{章节标题30}.txt
```

文件内容格式:
```
第1章 {章节标题}

{起始城镇},{主角家族}。
...
```

### 步骤5: 平台适配导出

#### 平台1: 起点中文网
```markdown
格式特点:
- 每章开头无需"第X章"前缀(平台自动添加)
- 章节标题单独一行
- 段落间单空行

示例:
{章节标题}

{起始城镇},{主角家族}。
...
```

输出:
```
releases/{project_id}/platforms/qidian/
├── chapter-001.txt
├── chapter-002.txt
...
```

#### 平台2: 晋江文学城
```markdown
格式特点:
- 保留"第X章"前缀
- 章节间三个空行
- 段落间单空行

示例:
第1章 {章节标题1}

{起始城镇},{主角家族}。
...



第2章 {章节标题2}
...
```

输出:
```
releases/{project_id}/platforms/jjwxc/novel.txt
```

#### 平台3: 番茄小说
```markdown
格式特点:
- 章节标题格式: 【第X章】标题
- 段落间单空行
- 章节间双空行

示例:
【第1章】{章节标题1}

{起始城镇},{主角家族}。
...


【第2章】{章节标题2}
...
```

输出:
```
releases/{project_id}/platforms/fanqie/novel.txt
```

### 步骤6: 生成元数据

创建metadata.txt:
```
《{小说名}》创作信息

基本信息:
- 题材: 玄幻
- 流派: 废柴流
- 总章节数: 30章
- 总字数: 93,500字
- 创作时间: 2023-11-13

导出内容:
- 通用TXT: novel.txt (93,500字)
- 带目录TXT: novel-with-toc.txt (94,200字,含目录)
- 分章TXT: chapters/ (30个文件)
- 起点格式: platforms/qidian/ (30个文件)
- 晋江格式: platforms/jjwxc/novel.txt
- 番茄格式: platforms/fanqie/novel.txt

文件位置: releases/novel_20231113/text/
```

输出:
```
releases/{project_id}/text/metadata.txt
```

---

## 输出目录结构

```
releases/{project_id}/text/
├── novel.txt                    # 纯合并版
├── novel-with-toc.txt           # 带目录版
├── metadata.txt                 # 元数据
├── chapters/                    # 分章版
│   ├── 第001章-废柴少年.txt
│   ├── 第002章-退婚之辱.txt
│   └── ...
└── platforms/                   # 平台适配版
    ├── qidian/                  # 起点中文网
    │   ├── chapter-001.txt
    │   └── ...
    ├── jjwxc/                   # 晋江文学城
    │   └── novel.txt
    └── fanqie/                  # 番茄小说
        └── novel.txt
```

---

## 使用示例

### 示例1: 导出所有章节

```bash
用户: "导出所有章节为TXT"

处理流程:
1. 扫描 productions/novel_xxx/chapters/
2. 找到30个chapter-*.md文件
3. 逐个处理,移除YAML和Markdown格式
4. 生成novel.txt (纯合并)
5. 生成novel-with-toc.txt (带目录)
6. 生成chapters/目录 (分章)
7. 生成platforms/目录 (平台适配)
8. 生成metadata.txt

输出:
✅ 导出完成!

文件位置: releases/novel_20231113/text/
├── novel.txt (30章, 9.3万字)
├── novel-with-toc.txt (带目录)
├── chapters/ (30个文件)
└── platforms/ (3个平台)

可用于:
  - 网文平台发布 (platforms/)
  - 个人阅读 (novel.txt)
  - 分章管理 (chapters/)
```

### 示例2: 仅导出指定章节

```bash
用户: "导出章节 1-10 为TXT"

处理流程:
1. 扫描chapter-0001.md到chapter-0010.md
2. 处理这10个文件
3. 生成partial-1-10.txt

输出:
✅ 部分导出完成!

文件位置: releases/novel_20231113/text/partial-1-10.txt
(10章, 3.1万字)
```

### 示例3: 仅导出特定平台格式

```bash
用户: "导出为起点格式"

处理流程:
1. 扫描所有章节
2. 按起点格式要求转换
3. 生成platforms/qidian/目录

输出:
✅ 起点格式导出完成!

文件位置: releases/novel_20231113/text/platforms/qidian/
(30个文件,每章独立)

可直接复制到起点作家后台批量上传。
```

---

## 格式转换规则

### Markdown → 纯文本

| Markdown | 纯文本 |
|----------|--------|
| `# 第1章 标题` | `第1章 标题` |
| `## 小节标题` | `小节标题` |
| `**粗体**` | `粗体` |
| `*斜体*` | `斜体` |
| `` `代码` `` | `代码` |
| `[链接](url)` | `链接` |
| `> 引用` | `引用` |

### 标点符号规范化

| 错误 | 正确 |
|------|------|
| `"双引号"` | `"双引号"` |
| `,逗号` | `,逗号` |
| `.句号` | `。句号` |
| `!感叹号` | `!感叹号` |
| `?问号` | `?问号` |

### 段落间距规范

```
规则:
- 同一段落: 连续文本,无换行
- 段落之间: 1个空行
- 章节之间: 2个空行
- 目录与正文: 多个━分隔线
```

---

## 字数统计

导出时自动统计:

```markdown
单章字数:
chapter-0001.md → 3,200字 (纯文本,不含YAML)

总字数:
30章 × 平均3,100字/章 = 93,000字

目录字数:
目录行数 × 平均15字/行 ≈ 450字

最终文件:
novel.txt: 93,000字
novel-with-toc.txt: 93,450字
```

---

## 注意事项

1. **保留原始文件**: 导出不修改 productions/{project_id}/chapters/ 下的Markdown原文件
2. **编码格式**: 所有TXT文件使用UTF-8编码(兼容性最好)
3. **文件命名**: 避免特殊字符,使用中文+数字+连字符
4. **自动创建目录**: releases/目录会自动创建,无需手动准备
5. **平台验证**: 导出后建议在平台后台测试上传,确认格式正确

---

## 扩展功能

### 自定义格式
用户可以指定:
- 章节间空行数
- 是否保留章节号
- 段落首行缩进(2空格或全角空格)

### 批量重命名
自动将:
```
chapter-0001.md → 第0001章-废柴少年.txt
chapter-0002.md → 第0002章-退婚之辱.txt
```

### 字数限制分割
如果平台限制单文件大小:
```
novel.txt (20万字)
→ novel-part1.txt (10万字, 1-105章)
→ novel-part2.txt (10万字, 106-210章)
```

---

激活条件: 用户说"导出章节"、"导出TXT"、"导出格式"等关键词,或Command "/export-all"

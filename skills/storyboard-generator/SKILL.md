---
name: storyboard-generator
description: |
  分镜脚本生成工具。将 SRT 字幕转换为视频分镜脚本，自动检测场景边界、
  识别角色和地点、生成时间码对齐的场景描述。

  使用场景：用户想要生成分镜脚本、制作视频分镜、从字幕生成场景时使用。
allowed-tools: Read, Write, Bash, Glob
---

# 分镜脚本生成器

将 TTS 生成的 SRT 字幕转换为视频分镜脚本，自动检测场景边界。

> **目录结构规范**: `specs/directory-structure.md`
> **模板参考**: `templates/storyboard-template.md`

## 工作流程

```
releases/{project_id}/tts/subtitles/{NNNN}.srt
    ↓ 解析 SRT 时间轴
    ↓ 检测场景边界
    ↓ 识别角色和地点
    ↓ 生成分镜脚本
releases/{project_id}/video/storyboard/storyboard.md
```

## 前置条件

必须先完成有声书生成：
```
releases/{project_id}/tts/subtitles/*.srt  # 必须存在
```

---

## 执行流程

### 步骤1: 验证字幕存在

```bash
ls releases/{project_id}/tts/subtitles/*.srt
```

如果不存在，提示用户先执行 `/nw-release audio`。

### 步骤2: 使用脚本解析 SRT

```bash
python {plugin_dir}/scripts/srt-to-storyboard.py \
    releases/{project_id}/tts/subtitles/0001.srt \
    releases/{project_id}/video/storyboard/chapter-0001.json \
    --scene-min-duration 5 \
    --merge-threshold 3
```

### 步骤3: 读取章节内容补充上下文

从 `productions/{project_id}/chapters/chapter-{NNNN}.md` 读取：
- 场景描述
- 角色对话
- 情绪转折

### 步骤4: 生成分镜脚本

将 JSON 数据转换为 Markdown 格式的分镜脚本。

### 步骤5: 输出结果

```bash
# 单章节分镜
releases/{project_id}/video/storyboard/chapter-0001.md

# 合并分镜（可选）
releases/{project_id}/video/storyboard/storyboard.md
```

---

## 场景边界检测规则

### 主要规则

| 规则 | 触发条件 | 示例 |
|------|----------|------|
| **地点变化** | 出现新地名 | "来到了青云峰"、"走进大殿" |
| **场景转换词** | 特定关键词 | "此时"、"另一边"、"与此同时" |
| **时间跳跃** | 时间标记 | "第二天"、"三年后"、"天亮时分" |
| **角色切换** | 视角/对话人变化 | 从主角视角切换到反派视角 |
| **情绪转折** | 明显情绪变化 | 紧张→轻松、悲伤→愤怒 |

### 辅助规则

| 规则 | 说明 |
|------|------|
| **最小时长** | 单场景不少于 5 秒 |
| **最大时长** | 单场景不超过 60 秒（建议拆分） |
| **合并阈值** | 间隔 < 3 秒的相似场景可合并 |

### 关键词列表

**地点变化词**:
```
来到、走进、走出、进入、离开、回到、抵达、踏入、
前往、返回、赶到、飞向、落在
```

**时间跳跃词**:
```
第二天、三天后、一个月后、数年后、片刻后、
天亮、天黑、黄昏、清晨、午时、夜半、
转眼、不久、随后、接着、继而
```

**场景转换词**:
```
此时、另一边、与此同时、就在这时、不远处、
话分两头、且说、却说
```

---

## 输出格式

参考 `templates/storyboard-template.md`：

```markdown
---
chapter: 1
source_srt: releases/{project_id}/tts/subtitles/0001.srt
total_duration: "00:12:35"
scene_count: 24
generated: 2024-01-15
---

# 第1章 分镜脚本

## 场景列表

| 场景 | 时间码 | 时长 | 地点 | 角色 | 情绪 | SRT序号 |
|------|--------|------|------|------|------|---------|
| 001 | 00:00:00-00:00:32 | 32s | 外门广场 | 萧羽, 李傲天 | 紧张 | 1-5 |
| ... | ... | ... | ... | ... | ... | ... |

## 场景详情

### 场景 001: {自动生成标题}
...
```

---

## 角色识别

### 从实体库读取

```bash
# 读取实体库获取角色列表
cat productions/{project_id}/data/entities.md
```

### 匹配规则

1. 精确匹配角色名
2. 匹配角色别名
3. 匹配角色称呼（"他"、"她" 根据上下文推断）

---

## 情绪识别

### 情绪关键词映射

| 关键词 | 情绪标签 |
|--------|----------|
| 怒喝、暴怒、震怒 | 愤怒 |
| 冷笑、嘲讽、讥讽 | 轻蔑 |
| 惊恐、颤抖、惧意 | 恐惧 |
| 欣喜、大笑、兴奋 | 喜悦 |
| 悲伤、泪流、哽咽 | 悲伤 |
| 平静、淡然、从容 | 平静 |
| 紧张、凝重、肃然 | 紧张 |
| 决然、坚定、毅然 | 坚定 |

---

## 镜头建议生成

根据场景内容自动推荐镜头类型：

| 场景类型 | 推荐镜头 |
|----------|----------|
| 场景建立 | 大远景 → 中景 |
| 对话 | 正反打、越肩镜头 |
| 战斗 | 快速切换、动态跟拍 |
| 内心独白 | 特写、推镜头 |
| 情感高潮 | 慢推特写 |
| 场景结束 | 拉远、淡出 |

---

## 使用示例

### 输入 SRT

```srt
1
00:00:00,000 --> 00:00:05,000
外门广场上，弟子们围成一圈。

2
00:00:05,000 --> 00:00:10,000
李傲天一身红袍，傲然而立。

3
00:00:10,000 --> 00:00:15,000
"萧羽，你这个废物，还敢出现在这里？"

4
00:00:15,000 --> 00:00:20,000
萧羽面色平静，缓缓抬头。

5
00:00:20,000 --> 00:00:25,000
"我为什么不能来？"
```

### 输出分镜

```markdown
### 场景 001: 广场对峙

**时间码**: 00:00:00 - 00:00:25
**时长**: 25秒
**SRT序号**: #1-5

**地点**: 外门广场
**角色**: 萧羽（主角）、李傲天（反派）
**情绪**: 紧张、对峙

**画面描述**:
外门广场上，弟子们围成一圈观看。李傲天身着红袍傲然而立，
嘲讽萧羽。萧羽面色平静，不卑不亢地回应。

**镜头建议**:
- 起始: 大远景，广场全貌
- 运动: 推进至双人中景
- 结束: 萧羽面部特写
```

---

## 注意事项

1. **手动调整**: 生成的分镜是初稿，用户可根据需要调整
2. **场景合并**: 过于碎片化的场景建议合并
3. **时长平衡**: 建议单场景 15-45 秒，过长可拆分
4. **角色确认**: 检查角色识别是否准确
